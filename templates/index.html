<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineSort - Movie & TV Raffle</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
</head>

<body>
    <div class="particles"></div>
    <div class="movie-backdrop-bg" id="backdropBg"></div>
    <div class="container" id="appContainer">
        <main>
            <!-- Home Screen -->
            <div id="homeScreen" class="home-screen">
                <div class="figma-container">
                    <div class="figma-background"></div>
                    <h1 class="figma-logo" id="logoHome" style="cursor: pointer;">CineSort</h1>
                    <button id="btnBack" class="figma-back-btn hidden">← Back</button>
                    <a href="#" class="figma-about" id="aboutHome">About the project</a>
                    <div class="figma-navbar-line"></div>

                    <!-- Initial buttons -->
                    <div id="initialButtons">
                        <button id="btnMovies" class="figma-btn-movies">Movies</button>
                        <button id="btnSeries" class="figma-btn-series">TV Series</button>
                        <p class="figma-subtitle">Don't know what to watch? Let destiny choose!</p>
                    </div>

                    <!-- Raffle content -->
                    <div id="raffleContent" class="raffle-content hidden">
                        <div class="genre-filter-toggle">
                            <a href="#" id="toggleGenreFilter">Click here to filter by genre</a>
                        </div>

                        <div class="genre-selector hidden" id="genreSelector">
                            <select id="genreSelect" class="genre-dropdown">
                                <option value="">All Genres</option>
                            </select>
                        </div>

                        <button id="btnRaffle" class="btn-raffle-figma">
                            Raffle
                        </button>

                        <div id="loading" class="loading hidden">
                            <div class="spinner"></div>
                            <p>Finding the perfect option...</p>
                        </div>

                        <div id="result" class="result hidden">
                            <div class="result-content">
                                <div class="movie-poster-container">
                                    <div class="movie-meta">
                                        <span class="rating">
                                            <span class="star">★</span>
                                            <span id="rating"></span>
                                        </span>
                                        <span class="meta-separator">•</span>
                                        <span id="year" class="year"></span>
                                        <span class="meta-separator">•</span>
                                        <span id="runtime" class="runtime"></span>
                                    </div>
                                    <img id="poster" src="" alt="Poster" class="movie-poster">
                                </div>
                                <div class="movie-info-details">
                                    <h2 id="title" class="movie-title"></h2>
                                    <div id="genres" class="genres"></div>
                                    <div class="credits">
                                        <p id="director" class="director"></p>
                                        <p id="cast" class="cast"></p>
                                    </div>
                                    <p id="synopsis" class="synopsis"></p>
                                    <div class="actions-center">

                                        <button id="btnNew" class="btn-new">
                                            Raffle Another
                                        </button>
                                        <button id="btnBackToRaffle" class="btn-back-raffle">
                                            ← Back
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="erro" class="erro hidden">
                        <p class="erro-mensagem"></p>
                        <button id="btnTentarNovamente" class="btn-sortear">
                            Try Again
                        </button>
                    </div>

                    <!-- About Section -->
                    <div id="aboutContent" class="about-content hidden">
                        <div class="about-container">
                            <button id="btnCloseAbout" class="btn-close-about">×</button>
                            <h2 class="about-title">About CineSort</h2>

                            <div class="about-section">
                                <h3>What is CineSort?</h3>
                                <p>CineSort is a minimalist web application designed to help you discover your next
                                    movie or TV series to watch. When you can't decide what to watch, let destiny choose
                                    for you!</p>
                            </div>

                            <div class="about-section">
                                <h3>How it works</h3>
                                <p>Simply select between Movies or TV Series, optionally filter by genre, and click
                                    Raffle. The app will randomly select a highly-rated option for you, complete with
                                    all the details you need to make your decision.</p>
                            </div>

                            <div class="about-section">
                                <h3>Features</h3>
                                <ul class="about-features">
                                    <li>Random movie and TV series recommendations</li>
                                    <li>Filter by genre to find exactly what you're in the mood for</li>
                                    <li>Beautiful, minimalist interface</li>
                                    <li>Powered by TMDB API for accurate and up-to-date information</li>
                                </ul>
                            </div>

                            <div class="about-section">
                                <h3>Technology</h3>
                                <p>Built with Flask, Python, and vanilla JavaScript. Data provided by <a
                                        href="https://www.themoviedb.org/" target="_blank" rel="noopener"
                                        class="about-link">The Movie Database (TMDB)</a>.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // State
        let currentType = null; // 'movie' or 'tv'

        // DOM Elements
        const homeScreen = document.getElementById('homeScreen');
        const initialButtons = document.getElementById('initialButtons');
        const raffleContent = document.getElementById('raffleContent');
        const btnMovies = document.getElementById('btnMovies');
        const btnSeries = document.getElementById('btnSeries');
        const logoHome = document.getElementById('logoHome');
        const aboutHome = document.getElementById('aboutHome');
        const btnBack = document.getElementById('btnBack');
        const btnRaffle = document.getElementById('btnRaffle');
        const btnNew = document.getElementById('btnNew');
        const btnBackResult = document.getElementById('btnBackResult');
        const genreSelect = document.getElementById('genreSelect');
        const loading = document.getElementById('loading');
        const result = document.getElementById('result');
        const appContainer = document.getElementById('appContainer');
        const aboutContent = document.getElementById('aboutContent');
        const btnCloseAbout = document.getElementById('btnCloseAbout');

        // Navigation
        btnMovies.addEventListener('click', () => {
            currentType = 'movie';
            transitionToRaffle();
        });

        btnSeries.addEventListener('click', () => {
            currentType = 'tv';
            transitionToRaffle();
        });

        // Click no logo volta para home
        if (logoHome) {
            logoHome.addEventListener('click', () => {
                if (currentType !== null) {
                    currentType = null;
                    transitionToHome();
                }
            });
        }

        // Click no botão Back volta para home
        if (btnBack) {
            btnBack.addEventListener('click', () => {
                currentType = null;
                transitionToHome();
            });
        }

        // Click no About abre a tela About
        if (aboutHome) {
            aboutHome.addEventListener('click', (e) => {
                e.preventDefault();
                transitionToAbout();
            });
        }

        // Click no botão X fecha o About
        if (btnCloseAbout) {
            btnCloseAbout.addEventListener('click', () => {
                transitionToHome();
            });
        }

        // Botão voltar no resultado
        if (btnBackResult) {
            btnBackResult.addEventListener('click', () => {
                result.classList.add('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }

        // Toggle genre filter
        const toggleGenreFilter = document.getElementById('toggleGenreFilter');
        const genreSelector = document.getElementById('genreSelector');

        toggleGenreFilter.addEventListener('click', (e) => {
            e.preventDefault();
            genreSelector.classList.toggle('hidden');
        });

        function transitionToRaffle() {
            // Ocultar about e mover logo
            aboutHome.classList.add('hidden');
            logoHome.classList.add('moved');
            btnBack.classList.remove('hidden');

            // Fade out dos botões iniciais
            initialButtons.style.opacity = '0';
            initialButtons.style.transition = 'opacity 0.3s ease';

            setTimeout(() => {
                // Esconder botões iniciais e mostrar conteúdo de raffle
                initialButtons.classList.add('hidden');
                raffleContent.classList.remove('hidden');
                result.classList.add('hidden');
                loading.classList.add('hidden');

                // Fade in do conteúdo de raffle
                raffleContent.style.opacity = '0';
                setTimeout(() => {
                    raffleContent.style.transition = 'opacity 0.3s ease';
                    raffleContent.style.opacity = '1';
                }, 10);

                const genreSelector = document.getElementById('genreSelector');
                genreSelector.classList.add('hidden');
                genreSelect.innerHTML = '<option value="">All Genres</option>';
                loadGenres();
            }, 300);
        }

        function transitionToHome() {
            // Desbloquear scroll
            document.documentElement.style.overflow = '';
            document.body.style.overflow = '';

            // Fade out do conteúdo de raffle ou about
            raffleContent.style.opacity = '0';
            raffleContent.style.transition = 'opacity 0.3s ease';
            aboutContent.style.opacity = '0';
            aboutContent.style.transition = 'opacity 0.3s ease';

            setTimeout(() => {
                // Esconder raffle, about e mostrar botões iniciais
                raffleContent.classList.add('hidden');
                aboutContent.classList.add('hidden');
                initialButtons.classList.remove('hidden');
                result.classList.add('hidden');
                loading.classList.add('hidden');

                // Restaurar about, logo e esconder back
                aboutHome.classList.remove('hidden');
                aboutHome.style.opacity = '1';
                logoHome.classList.remove('hidden');
                logoHome.classList.remove('moved');
                logoHome.style.opacity = '1';
                btnBack.classList.add('hidden');

                // Fade in dos botões iniciais
                initialButtons.style.opacity = '0';
                setTimeout(() => {
                    initialButtons.style.transition = 'opacity 0.3s ease';
                    initialButtons.style.opacity = '1';
                }, 10);
            }, 300);

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function transitionToAbout() {
            // Bloquear scroll
            document.documentElement.style.overflow = 'hidden';
            document.body.style.overflow = 'hidden';

            // Fade out do conteúdo inicial
            initialButtons.style.opacity = '0';
            initialButtons.style.transition = 'opacity 0.3s ease';
            aboutHome.style.opacity = '0';
            logoHome.style.opacity = '0';

            setTimeout(() => {
                // Esconder inicial e mostrar About
                initialButtons.classList.add('hidden');
                raffleContent.classList.add('hidden');
                aboutHome.classList.add('hidden');
                logoHome.classList.add('hidden');
                aboutContent.classList.remove('hidden');

                // Fade in do About
                aboutContent.style.opacity = '0';
                setTimeout(() => {
                    aboutContent.style.transition = 'opacity 0.3s ease';
                    aboutContent.style.opacity = '1';
                }, 10);
            }, 300);
        }

        // Load genres on page load
        async function loadGenres() {
            try {
                const endpoint = currentType === 'tv' ? '/api/genres-tv' : '/api/genres';
                const response = await fetch(endpoint);
                const data = await response.json();

                if (data.genres) {
                    data.genres.forEach(genre => {
                        const option = document.createElement('option');
                        option.value = genre.id;
                        option.textContent = genre.name;
                        genreSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading genres:', error);
            }
        }

        async function raffleMovie() {
            result.classList.add('hidden');
            document.getElementById('erro').classList.add('hidden');
            loading.classList.remove('hidden');

            try {
                const genreId = genreSelect.value;
                const endpoint = currentType === 'tv' ? '/api/raffle-tv' : '/api/raffle-movie';
                const url = genreId ? `${endpoint}?genre_id=${genreId}` : endpoint;
                const response = await fetch(url);

                const data = await response.json();

                if (!response.ok || data.error) {
                    throw new Error(data.error || 'Error fetching data');
                }

                document.getElementById('title').textContent = data.title;
                document.getElementById('rating').textContent = data.rating.toFixed(1);
                document.getElementById('synopsis').textContent = data.synopsis || 'Synopsis not available';

                if (data.release_date) {
                    const year = new Date(data.release_date).getFullYear();
                    document.getElementById('year').textContent = year;
                }

                if (data.runtime && data.runtime > 0) {
                    const hours = Math.floor(data.runtime / 60);
                    const minutes = data.runtime % 60;
                    document.getElementById('runtime').textContent =
                        `${hours}h ${minutes}min`;
                } else {
                    document.getElementById('runtime').textContent = '';
                }

                const genresContainer = document.getElementById('genres');
                genresContainer.innerHTML = '';
                data.genres.forEach(genre => {
                    const badge = document.createElement('span');
                    badge.className = 'genre-badge';
                    badge.textContent = genre;
                    genresContainer.appendChild(badge);
                });

                if (data.director) {
                    document.getElementById('director').innerHTML =
                        `<strong>Director:</strong> ${data.director}`;
                } else {
                    document.getElementById('director').textContent = '';
                }

                if (data.cast && data.cast.length > 0) {
                    document.getElementById('cast').innerHTML =
                        `<strong>Cast:</strong> ${data.cast.join(', ')}`;
                } else {
                    document.getElementById('cast').textContent = '';
                }

                const poster = document.getElementById('poster');
                if (data.poster) {
                    poster.src = data.poster;
                    poster.alt = `Poster for ${data.title}`;
                } else {
                    poster.src = 'https://via.placeholder.com/500x750/333/fff?text=No+Poster';
                }

                const backdrop = document.getElementById('backdropBg');
                if (data.backdrop) {
                    backdrop.style.backgroundImage = `url(${data.backdrop})`;
                    backdrop.classList.add('active');
                }

                // Esconder botões de raffle e genre quando mostrar resultado
                document.getElementById('btnRaffle').classList.add('hidden');
                document.querySelector('.genre-filter-toggle').classList.add('hidden');
                document.getElementById('genreSelector').classList.add('hidden');

                const backdropBg = document.getElementById('backdropBg');
                if (data.backdrop) {
                    backdropBg.style.backgroundImage = `url(${data.backdrop})`;
                    backdropBg.classList.add('active');
                }

                // Esconder botões de raffle e genre quando mostrar resultado
                document.getElementById('btnRaffle').classList.add('hidden');
                document.querySelector('.genre-filter-toggle').classList.add('hidden');
                document.getElementById('genreSelector').classList.add('hidden');

                loading.classList.add('hidden');
                result.classList.remove('hidden');

                setTimeout(() => {
                    result.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);

            } catch (err) {
                console.error('Error:', err);
                loading.classList.add('hidden');
                result.classList.add('hidden');

                const erro = document.getElementById('erro');
                const erroMensagem = document.querySelector('.erro-mensagem');

                // Esconder botões de raffle quando mostrar erro
                document.getElementById('btnRaffle').classList.add('hidden');
                document.querySelector('.genre-filter-toggle').classList.add('hidden');
                document.getElementById('genreSelector').classList.add('hidden');

                // Check if it's a "not found" error
                if (err.message.includes('No movies found') || err.message.includes('No TV shows found')) {
                    erroMensagem.textContent = currentType === 'tv'
                        ? 'No TV series found with the selected filters. Try another genre or "All Genres"!'
                        : 'No movies found with the selected filters. Try another genre or "All Genres"!';
                } else {
                    erroMensagem.textContent = 'Oops! Something went wrong. Try again.';
                }

                erro.classList.remove('hidden');

                setTimeout(() => {
                    erro.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        }

        btnRaffle.addEventListener('click', raffleMovie);
        btnNew.addEventListener('click', () => {
            result.classList.add('hidden');
            document.getElementById('backdropBg').classList.remove('active');
            document.getElementById('btnRaffle').classList.remove('hidden');
            document.querySelector('.genre-filter-toggle').classList.remove('hidden');
            document.getElementById('erro').classList.add('hidden');
            raffleMovie();
        });

        // Botão Back para voltar à configuração
        const btnBackToRaffle = document.getElementById('btnBackToRaffle');
        if (btnBackToRaffle) {
            btnBackToRaffle.addEventListener('click', () => {
                result.classList.add('hidden');
                document.getElementById('backdropBg').classList.remove('active');
                document.getElementById('btnRaffle').classList.remove('hidden');
                document.querySelector('.genre-filter-toggle').classList.remove('hidden');
                document.getElementById('erro').classList.add('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }

        document.getElementById('btnTentarNovamente').addEventListener('click', () => {
            // Esconder erro
            document.getElementById('erro').classList.add('hidden');

            // Limpar backdrop
            const backdropBg = document.getElementById('backdropBg');
            backdropBg.style.backgroundImage = '';
            backdropBg.classList.remove('active');

            // Esconder resultado se estiver visível
            document.getElementById('result').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');

            // Resetar filtro de gênero para "All Genres"
            document.getElementById('genreSelect').value = '';
            document.getElementById('genreSelector').classList.add('hidden');

            // Mostrar tela de raffle
            document.getElementById('raffleContent').classList.remove('hidden');
            document.getElementById('btnRaffle').classList.remove('hidden');
            document.querySelector('.genre-filter-toggle').classList.remove('hidden');
        });

        // Load genres when page loads
        window.addEventListener('load', () => {
            showHomeScreen();
        });
    </script>
</body>

</html>